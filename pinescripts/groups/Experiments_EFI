//@version=5
strategy("EFI", overlay=true, pyramiding=1)

quoteGreen(c, o) => c >= o

f_round(_val, _decimals) =>
    _p = math.pow(10, _decimals)
    math.round(math.abs(_val) * _p)/ _p * math.sign(_val)

efi() =>
    src = ((close - close[1]) * volume)
    efi = ta.ema(src, 13)

thirdSecondNegativeAndAscending = efi()[2] < 0 and efi()[1] < 0 and efi()[1] > efi()[2]
lastPositiveAndAscending = efi() > 0 and efi() > efi()[1]

allPassed = thirdSecondNegativeAndAscending and lastPositiveAndAscending

[middleKC, upperKC, lowerKC] = request.security(syminfo.tickerid, 'D', ta.kc(close, 20, 2), lookahead=barmerge.lookahead_on)

balance = strategy.initial_capital + strategy.netprofit
balanceToUse = balance / 100 * 5
lots = balanceToUse / close

arrayToFindMin = array.new_float(size=10, initial_value=9999999)
for offset = 0 to 20
    array.insert(arrayToFindMin, offset, low[offset])
fixedSL = ta.valuewhen(allPassed, array.min(id=arrayToFindMin) - 0.27, 0)

diff = upperKC - middleKC
ratio = diff / 100 * 95
fixedTP = ta.valuewhen(allPassed, middleKC + ratio, 0)

if (allPassed)
    strategy.entry("Long", strategy.long, qty = lots)
    strategy.exit("Long", stop = fixedSL, limit = fixedTP)

plot(strategy.position_size <= 0 ? na : fixedSL, color=color.red, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size <= 0 ? na : fixedTP, color=color.green, style=plot.style_linebr, linewidth=2)
// !!! Если убрать Long_ScreenOne_EMA_LastBarCrosses, то net profit и число сделок выше, без существенного снижения процента прибыльных сделок


//@version=5
strategy("Buy 4", overlay = true, initial_capital = 10000, default_qty_type = strategy.percent_of_equity, default_qty_value = 10, commission_type = strategy.commission.cash_per_contract, commission_value = 0.005)

// functions
quoteGreen(c, o) => c >= o
f_round(_val, _decimals) =>
    _p = math.pow(10, _decimals)
    math.round(math.abs(_val) * _p)/ _p * math.sign(_val)

// quotes
[screen_1_open, screen_1_high, screen_1_low, screen_1_close]  = request.security(syminfo.tickerid, 'W', [open, high, low, close], lookahead=barmerge.lookahead_on)
[screen_1_open_prev, screen_1_high_prev, screen_1_low_prev, screen_1_close_prev] = request.security(syminfo.tickerid, 'W', [open[1], high[1], low[1], close[1]], lookahead=barmerge.lookahead_on)
[screen_2_open, screen_2_high, screen_2_low, screen_2_close] = request.security(syminfo.tickerid, 'D', [open, high, low, close])

// indicators
screen_1_EMA26 = request.security(syminfo.tickerid, "W", ta.ema(close, 26), lookahead=barmerge.lookahead_on)
screen_1_EMA26_prev = request.security(syminfo.tickerid, "W", ta.ema(close, 26)[1], lookahead=barmerge.lookahead_on)
screen_2_EMA13 = request.security(syminfo.tickerid, "D", ta.ema(close, 13))
[screen_1_MACD, screen_1_MACDSignal, screen_1_MACDHistorgram] = request.security(syminfo.tickerid, "1W", ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_on)
[screen_2_MACD, screen_2_MACDSignal, screen_2_MACDHistogram] = request.security(syminfo.tickerid, "D", ta.macd(close, 12, 26, 9))
screen_2_stoch_k = ta.stoch(screen_2_close, screen_2_high, screen_2_low, 14)
screen_2_stoch_d = ta.sma(screen_2_stoch_k, 3)
[screen_2_KC_middle, screen_2_KC_top, screen_2_KC_bottom] = request.security(syminfo.tickerid, 'D', ta.kc(close, 20, 2), lookahead=barmerge.lookahead_on)

currH = screen_1_MACDHistorgram
prevH = screen_1_MACDHistorgram
if (prevH == currH)
    prevH := screen_1_MACDHistorgram[1]
if (prevH == currH)
    prevH := screen_1_MACDHistorgram[2]
if (prevH == currH)
    prevH := screen_1_MACDHistorgram[2]
if (prevH == currH)
    prevH := screen_1_MACDHistorgram[3]
if (prevH == currH)
    prevH := screen_1_MACDHistorgram[4]

Short_ScreenOne_LastBarRed = not quoteGreen(screen_1_close, screen_1_open)
Short_ScreenOne_LastBarLower = screen_1_low_prev > screen_1_low and screen_1_high_prev > screen_1_high
Short_ScreenOne_EMA_LastBarCrosses = screen_1_low <= screen_1_EMA26 and screen_1_high >= screen_1_EMA26
Short_ScreenOne_MACD_LastDescending = screen_1_MACDHistorgram < prevH
Short_ScreenTwo_Bars_TwoHighDescending = screen_2_high < screen_2_high[1]
Short_screen_2_last_bar_below_EMA13 = screen_2_low < screen_2_EMA13 and screen_2_high < screen_2_EMA13
Short_ScreenTwo_EMA_LastBarNotBelow = not Short_screen_2_last_bar_below_EMA13
Short_ScreenTwo_MACD_LastDescending = screen_2_MACDHistogram < screen_2_MACDHistogram[1]
Short_ScreenTwo_Stoch_D_K_LastDescending = screen_2_stoch_k < screen_2_stoch_k[1] and screen_2_stoch_d < screen_2_stoch_d[1]
lateEntry = close <= screen_2_KC_middle - (screen_2_KC_middle- screen_2_KC_bottom) / 100 * 80
descendingEMA26 = f_round(screen_1_EMA26_prev, 2) > f_round(screen_1_EMA26, 2)
lastWeeklyQuoteRed = not quoteGreen(screen_1_close, screen_1_open)
Short_ScreenOne_SoftTrendCheck = descendingEMA26 and lastWeeklyQuoteRed

shortCondition = Short_ScreenOne_SoftTrendCheck and not lateEntry and Short_ScreenOne_LastBarRed and Short_ScreenOne_MACD_LastDescending and Short_ScreenTwo_Bars_TwoHighDescending and Short_ScreenTwo_Stoch_D_K_LastDescending

// arrayToFindMax = array.new_float(size=10, initial_value=0)
// for offset = 0 to 10
//     array.insert(arrayToFindMax, offset, screen_2_low[offset])
// max = array.max(id=arrayToFindMax)
fixedSL_short = ta.valuewhen(shortCondition, screen_2_KC_top, 0)

short_TL_ratio = (screen_2_KC_middle - screen_2_KC_bottom) / 100 * 80
fixedTP_short = ta.valuewhen(shortCondition, low >= screen_2_KC_middle + (screen_2_KC_top - screen_2_KC_middle) / 100 * 50 ? screen_2_KC_middle - (screen_2_KC_middle - screen_2_KC_bottom) / 100 * 30: screen_2_KC_middle - short_TL_ratio, 0)

barIndexEntry = ta.valuewhen(shortCondition, bar_index, 0)

if (shortCondition)
    strategy.entry("Short", strategy.short)

//plotchar(strategy.position_size, title = 'strategy.position_size')
// plotchar(fixedSL_short, title = 'fixedSL')
// plotchar(fixedTP_short, title = 'fixedTP')

if (bar_index - barIndexEntry > 1)
    strategy.exit(id = "exit", from_entry = "Short", stop = fixedSL_short, limit = fixedTP_short, comment_profit = "Profit", comment_loss = "Loss")

// if (screen_2_stoch_d >= screen_2_stoch_d[1])
//     strategy.exit(id = "exit", from_entry = "Short", stop = fixedSL_short, limit = close, comment_profit = "Profit", comment_loss = "Loss")

float lastTradeProfit = na
if strategy.position_size != strategy.position_size[1]
    lastTradeProfit := strategy.netprofit - strategy.netprofit[1]
//plot(lastTradeProfit, style = plot.style_columns, color = lastTradeProfit > 0 ? color.green : lastTradeProfit == 0 ? color.gray : color.red, title = "Trade profit/loss")